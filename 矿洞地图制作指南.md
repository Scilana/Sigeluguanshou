# 矿洞地图制作指南

## 概述

本指南将教你如何使用 **Tiled Map Editor** 制作矿洞地图（TMX 格式），并正确集成到游戏中。

## 一、准备工作

### 1.1 下载并安装 Tiled

- 官网：https://www.mapeditor.org/
- 下载最新版本（推荐 1.9+ 版本）
- 安装后打开 Tiled

### 1.2 准备 Tileset 图片

你需要准备以下类型的瓦片图集：

1. **地面瓦片** (`mine_floor.png`)
   - 矿洞地面、石板、泥土等
   - 推荐尺寸：256x256 或更大
   - 每个瓦片：32x32 像素

2. **墙壁/障碍瓦片** (`mine_walls.png`)
   - 岩石墙壁、石柱等
   - 用于碰撞检测

3. **矿物瓦片** (`mine_minerals.png`)
   - 铜矿石、铁矿石、金矿石、宝石等
   - 这些会被玩家挖掘

4. **楼梯瓦片** (`mine_stairs.png`)
   - 下楼梯图标
   - 玩家站在上面可以进入下一层

**瓦片图集放置位置：**
```
d:\StardewFarm-new\Sigeluguanshou\Resources\map\
├── mine_floor.png
├── mine_walls.png
├── mine_minerals.png
└── mine_stairs.png
```

### 1.3 参考现有地图

你可以参考项目中的 `Resources/map/farm.tmx` 来了解基本结构。

---

## 二、创建矿洞地图

### 2.1 新建地图

1. 打开 Tiled，点击 **文件 → 新建 → 新建地图**
2. 设置参数：
   - **方向**：正交 (Orthogonal)
   - **瓦片层格式**：CSV 或 Base64（推荐 CSV，便于调试）
   - **瓦片渲染顺序**：右下
   - **地图大小**：
     - 宽度：40 瓦片
     - 高度：30 瓦片
   - **瓦片大小**：
     - 宽度：32 像素
     - 高度：32 像素

3. 点击 **保存**，命名为 `mine_floor1.tmx`，保存到：
   ```
   d:\StardewFarm-new\Sigeluguanshou\Resources\map\mine_floor1.tmx
   ```

### 2.2 添加 Tileset（瓦片集）

#### 添加地面瓦片集

1. 点击 **地图 → 新建瓦片集**
2. 设置：
   - **名称**：`mine_floor`
   - **类型**：基于图块集图像
   - **图像**：点击 **浏览**，选择 `mine_floor.png`
   - **瓦片宽度**：32
   - **瓦片高度**：32
   - **边距/间距**：0
3. 点击 **保存到地图**

#### 添加其他瓦片集

重复上述步骤，依次添加：
- `mine_walls` (墙壁)
- `mine_minerals` (矿物)
- `mine_stairs` (楼梯)

---

### 2.3 创建图层（Layers）

**重要**：图层名称必须严格按照以下命名，否则代码无法识别！

#### 图层 1: base（基础层）

1. 右键图层面板 → **添加图层 → 瓦片图层**
2. 命名为 `base`
3. 用途：矿洞地面
4. 使用 `mine_floor` 瓦片集绘制地面

**绘制技巧：**
- 使用填充工具（快捷键 F）快速填充大片区域
- 用画笔工具（快捷键 B）绘制细节

#### 图层 2: collision（碰撞层）

1. 添加新瓦片图层，命名为 `collision`
2. 用途：墙壁、障碍物（不可行走）
3. 使用 `mine_walls` 瓦片集绘制墙壁

**重要提示：**
- 这一层的任何有 GID 的瓦片都会被视为障碍
- 通常绘制矿洞四周的墙壁
- 可以添加石柱、大石头等装饰性障碍

**设置碰撞层不可见：**
- 在 Tiled 中，碰撞层需要可见才能编辑
- 代码会自动隐藏这一层（`collisionLayer_->setVisible(false)`）

#### 图层 3: mineral（矿物层）

1. 添加新瓦片图层，命名为 `mineral`
2. 用途：可挖掘的矿物
3. 使用 `mine_minerals` 瓦片集

**矿物放置建议：**
- 铜矿石：较多，分布在浅层
- 铁矿石：中等数量
- 金矿石：较少，深层才有
- 宝石：稀有，随机散布

**矿物 GID 记录：**

在绘制时，记住每种矿物对应的 GID（瓦片 ID）：

1. 打开 Tiled，选中 `mine_minerals` 瓦片集
2. 点击一个矿物瓦片
3. 查看右下角 **属性** 面板，记录 **ID** 或 **GID**

例如：
- 铜矿石 GID：1002
- 铁矿石 GID：1003
- 金矿石 GID：1004
- 宝石 GID：1005

**稍后需要在代码中配置这些 GID！**

#### 图层 4: stairs（楼梯层）

1. 添加新瓦片图层，命名为 ``stairs
2. 用途：下楼通道
3. 使用 `mine_stairs` 瓦片集

**楼梯放置建议：**
- 每层只放置 1-2 个楼梯
- 通常放在角落或需要探索才能找到的位置
- 玩家站在楼梯上按 Enter 可以下楼

---

### 2.4 图层顺序（从下到上）

确保图层顺序正确（在 Tiled 左侧图层面板中）：

```
[顶层]
4. stairs
3. mineral
2. collision
1. base
[底层]
```

可以通过拖拽调整图层顺序。

---

## 三、地图设计建议

### 3.1 布局设计

**推荐布局：**

```
┌────────────────────────────────────┐
│ ████████████████████████████████ │  ← 顶部墙壁
│ █                                █ │
│ █   [入口]                       █ │
│ █                                █ │
│ █     ⛏️  ⛏️     ⛏️              █ │  ← 矿物散布
│ █                                █ │
│ █  ⛏️         ⛏️    ⛏️           █ │
│ █                                █ │
│ █        💎    ⛏️                █ │
│ █                                █ │
│ █    ⛏️             [楼梯]       █ │
│ █                                █ │
│ ████████████████████████████████ │  ← 底部墙壁
└────────────────────────────────────┘
```

### 3.2 设计原则

1. **四周围墙**：确保矿洞四周有碰撞层，防止玩家走出地图
2. **通道设计**：留出足够的空间让玩家行走
3. **矿物分布**：不要太密集，保持探索乐趣
4. **视觉层次**：
   - 基础层：统一的地面纹理
   - 矿物层：点缀式分布
   - 墙壁层：边界和障碍

### 3.3 多层设计

如果要创建多层矿洞：

1. 复制 `mine_floor1.tmx` 为 `mine_floor2.tmx`
2. 修改矿物分布（深层矿物更珍贵）
3. 调整难度（更多障碍，更少资源）

---

## 四、保存和导出

### 4.1 保存地图

1. 点击 **文件 → 保存**
2. 确保文件保存为：
   ```
   d:\StardewFarm-new\Sigeluguanshou\Resources\map\mine_floor1.tmx
   ```

### 4.2 检查 Tileset 路径

打开 `mine_floor1.tmx`（用文本编辑器），检查瓦片集路径：

```xml
<tileset firstgid="1" name="mine_floor" tilewidth="32" tileheight="32">
  <image source="mine_floor.png" width="256" height="256"/>
</tileset>
```

确保 `source` 是相对路径（不是绝对路径）！

**错误示例（绝对路径）：**
```xml
<image source="D:/StardewFarm-new/Sigeluguanshou/Resources/map/mine_floor.png" .../>
```

**正确示例（相对路径）：**
```xml
<image source="mine_floor.png" .../>
```

如果是绝对路径，需要手动修改为相对路径。

---

## 五、集成到游戏

### 5.1 配置矿物 GID

打开 `d:\StardewFarm-new\Sigeluguanshou\Classes\MiningManager.cpp`，找到 `initMineralDefs()` 函数。

**修改 GID 值：**

```cpp
void MiningManager::initMineralDefs()
{
    // 根据你在 Tiled 中记录的 GID 修改这里的值

    // 铜矿石 - 修改为你的实际 GID
    mineralDefs_[1002] = MineralDef{
        1002,
        "Copper Ore",
        3,                      // 需要敲击3次
        ItemType::Wood,         // 临时使用 Wood（你可以添加新的 ItemType）
        1, 3,                   // 掉落1-3个
        5                       // 5点经验
    };

    // 铁矿石
    mineralDefs_[1003] = MineralDef{
        1003,
        "Iron Ore",
        5,
        ItemType::Wood,
        1, 2,
        10
    };

    // ... 继续添加其他矿物
}
```

**如何查找实际 GID：**

1. 打开 `mine_floor1.tmx`（Tiled）
2. 选择 **矿物层**
3. 使用 **选择工具** 点击一个矿物瓦片
4. 查看 **属性** 面板中的 **GID** 值
5. 记录并更新代码

### 5.2 添加场景切换入口

在 `GameScene` 中添加进入矿洞的入口。

**方案 1：特定位置触发**

在 `GameScene::update()` 中检测玩家位置：

```cpp
void GameScene::update(float delta)
{
    // ... 现有代码

    // 检查是否在矿洞入口
    if (player_ && mapLayer_)
    {
        Vec2 playerTile = mapLayer_->positionToTileCoord(player_->getPosition());

        // 假设矿洞入口在瓦片 (10, 15)
        if (playerTile.x == 10 && playerTile.y == 15)
        {
            // 显示提示
            if (!mineEntranceHintShown_)
            {
                showActionMessage("Press M to enter mine", Color3B(255, 215, 0));
                mineEntranceHintShown_ = true;
            }
        }
        else
        {
            mineEntranceHintShown_ = false;
        }
    }
}
```

**方案 2：按键直接进入**

在 `GameScene::onKeyPressed()` 中添加：

```cpp
case EventKeyboard::KeyCode::KEY_M:
    enterMine();
    break;
```

然后添加函数：

```cpp
void GameScene::enterMine()
{
    CCLOG("Entering mine...");

    // 切换到矿洞场景
    auto mineScene = MineScene::createScene(inventory_, 1);
    Director::getInstance()->replaceScene(TransitionFade::create(1.0f, mineScene));
}
```

### 5.3 更新 GameScene.h

在 `GameScene.h` 中添加：

```cpp
#include "MineScene.h"  // 在文件顶部添加

// 在 private 区域添加
void enterMine();
bool mineEntranceHintShown_ = false;
```

---

## 六、测试清单

### 6.1 地图加载测试

1. 编译并运行游戏
2. 按 M 键（或你设置的按键）进入矿洞
3. 检查控制台输出：
   ```
   Loading mine map: map/mine_floor1.tmx
   Mine map loaded successfully
   Mine layers initialized
   ```

### 6.2 图层测试

- [ ] 玩家可以正常移动
- [ ] 墙壁阻挡玩家（collision 层有效）
- [ ] 矿物显示正确
- [ ] 楼梯显示正确

### 6.3 挖矿测试

1. 走到矿物旁边
2. 按 J 键挖矿
3. 检查：
   - [ ] 出现 "Mining... (X more)" 提示
   - [ ] 连续按 J，矿物被破坏
   - [ ] 物品添加到背包
   - [ ] 矿物瓦片消失

### 6.4 楼梯测试

1. 走到楼梯上
2. 按 Enter 键
3. 检查：
   - [ ] 场景切换到下一层
   - [ ] 楼层数显示正确（Floor 2, Floor 3...）
   - [ ] 背包数据保持（不会丢失）

---

## 七、常见问题

### Q1: 地图无法加载，显示 "Failed to load mine map"

**可能原因：**
- TMX 文件路径错误
- TMX 文件不在 `Resources/map/` 目录
- 文件名大小写错误（Linux 区分大小写）

**解决方案：**
- 确保文件路径正确：`Resources/map/mine_floor1.tmx`
- 检查 `MineScene::initMap()` 中的文件名
- 重新编译并复制资源文件

### Q2: 图层名称警告 "WARNING: 'base' layer not found"

**原因：**
- 图层名称拼写错误
- 图层名称大小写错误

**解决方案：**
- 在 Tiled 中，右键图层 → 图层属性
- 确保名称完全匹配：`base`, `collision`, `mineral`, `stairs`

### Q3: 玩家可以穿墙

**原因：**
- collision 层未正确设置
- 墙壁瓦片 GID 为 0（空瓦片）

**解决方案：**
- 在 Tiled 中检查 collision 层
- 确保墙壁位置有瓦片（非空）
- 使用 **显示/隐藏图层** 检查碰撞层

### Q4: 挖矿无效，没有反应

**原因：**
- 矿物 GID 与代码中的不匹配
- 矿物层为空

**解决方案：**
- 在 Tiled 中查看矿物的实际 GID
- 更新 `MiningManager::initMineralDefs()` 中的 GID 值
- 确保 mineral 层有矿物瓦片

### Q5: Tileset 图片显示为问号或红叉

**原因：**
- 图片路径错误（绝对路径）
- 图片文件不存在

**解决方案：**
- 将 tileset PNG 文件放到 `Resources/map/` 目录
- 修改 TMX 文件中的 `<image source="...">` 为相对路径
- 重新在 Tiled 中打开并保存

---

## 八、高级技巧

### 8.1 添加对象层（Object Layer）

可以用对象层标记特殊位置：

1. 添加 **对象图层** → 命名为 `spawn_points`
2. 使用 **矩形工具** 标记玩家出生点
3. 在代码中读取对象坐标：

```cpp
auto objectGroup = tmxMap_->getObjectGroup("spawn_points");
if (objectGroup)
{
    auto objects = objectGroup->getObjects();
    for (const auto& obj : objects)
    {
        ValueMap dict = obj.asValueMap();
        float x = dict["x"].asFloat();
        float y = dict["y"].asFloat();
        // 使用坐标...
    }
}
```

### 8.2 自定义属性

为瓦片添加自定义属性：

1. 在 Tiled 中，选择瓦片集
2. 点击一个瓦片
3. 在 **自定义属性** 面板添加属性，如：
   - `mineral_type` = "copper"
   - `hardness` = 3

### 8.3 动态生成地图

可以用代码动态生成随机矿洞：

```cpp
void generateRandomMine(int floor)
{
    // 随机生成墙壁
    // 随机放置矿物
    // 随机放置楼梯
}
```

---

## 九、资源参考

### 9.1 推荐的 Tileset

**免费资源网站：**
- https://opengameart.org/
- https://itch.io/game-assets/free
- https://kenney.nl/assets

**搜索关键词：**
- "mine tileset"
- "dungeon tileset"
- "cave tileset 32x32"

### 9.2 Tiled 官方文档

- 官方手册：https://doc.mapeditor.org/en/stable/
- TMX 格式说明：https://doc.mapeditor.org/en/stable/reference/tmx-map-format/

---

## 十、完整文件路径总结

```
d:\StardewFarm-new\Sigeluguanshou\
├── Resources\
│   └── map\
│       ├── mine_floor1.tmx          ← 你创建的地图文件
│       ├── mine_floor.png           ← 地面瓦片图集
│       ├── mine_walls.png           ← 墙壁瓦片图集
│       ├── mine_minerals.png        ← 矿物瓦片图集
│       └── mine_stairs.png          ← 楼梯瓦片图集
├── Classes\
│   ├── MineScene.h/cpp              ← 矿洞场景
│   ├── MineLayer.h/cpp              ← 矿洞地图层
│   └── MiningManager.h/cpp          ← 挖矿管理器
└── CMakeLists.txt                   ← 已更新
```

---

## 祝你制作愉快！🎮⛏️

如有问题，请查看控制台日志（CCLOG 输出）进行调试。
