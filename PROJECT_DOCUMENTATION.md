# 项目说明文档（玩法 + 技术实现）

## 文档信息
- 项目名称：星露谷关守 (StardewFarm)
- 引擎：Cocos2d-x 3.17
- 语言：C++11/14
- 文档目标：整合玩法说明与技术实现，便于玩家与开发协作阅读

---

# 第一部分：游戏玩法说明

## 1. 基础操作

### 1.1 移动与菜单
- W / A / S / D：角色移动
- ESC：系统菜单（交易界面中为关闭界面）
- M：电梯交互（矿洞入口/电梯附近打开楼层选择）
- Enter：进入下一层/房间
- B：打开/关闭背包
- E：打开技能树
- P：查看市场价格/进入交易
- Tab：跳过时间到第二天早晨（调试用）

### 1.2 物品栏与切换
- 数字键 1 - 0：切换工具/物品
- 减号键 (-)：切换第 11 个物品
- 鼠标滚轮：部分场景支持切换

### 1.3 通用交互
- J：通用工具/攻击键（耕地、种植、收获、砍树、挖矿、攻击）
- K：特殊交互（放置储物箱、许愿池）
- Space：开启箱子/与 NPC 对话或交易
- 鼠标左键：背包物品交换、钓鱼操作、点击 NPC 交互、地图坐标调试

> 注意：能量条低于 20% 变红时无法使用 J 键工作或攻击。

## 2. 工具与物品

| 按键 | 物品 | 功能 | 操作 |
| :--- | :--- | :--- | :--- |
| 1 | 锄头 | 开垦土地 | 面向地块按 J |
| 2 | 喷壶 | 浇水 | 面向耕地按 J 或 K |
| 3 | 镰刀 | 收获作物 | 面向作物按 J |
| 4 | 斧头 | 砍树/清理障碍 | 面向树木按 J |
| 5 | 钓鱼竿 | 钓鱼 | 详见钓鱼章节 |
| 6-0, - | 各类种子 | 种植作物 | 面向耕地按 J |
| 掉落 | 剑 | 攻击怪物 | 面向怪物按 J |

## 3. 核心玩法

### 3.1 农耕系统
1. 开垦：锄头 (键 1) + J
2. 播种：种子 (键 6-0) + J
3. 浇水：喷壶 (键 2) + J/K（每日需要）
4. 收获：作物成熟后镰刀 (键 3) + J

### 3.2 天气系统
- 晴天：无特殊效果
- 雨天：耕地自动浇水（鱼类概率可能变化）
- 雪天：市场物价上涨，独特视觉效果
- 查看天气：右上角 UI 或 P 键；电视机可查看 7 天预报

### 3.3 NPC 与交易
- 商人固定在农场地图位置（如 [500, 400]）
- Space 或鼠标点击交互
- Buy / Sell 进入购买或出售界面

### 3.4 矿洞探险
1. 进入矿洞：靠近电梯按 M 选择楼层
2. 战斗：史莱姆（快、血低）、僵尸（慢、血高），J 攻击
3. 挖矿：铜/银/金矿，J 挖掘，消耗能量
4. 许愿池：5 的倍数层概率出现，K 投入物品获得奖励
5. 宝箱：Space 开启，同层每周刷新一次
6. 电梯换层：靠近电梯井按 J 打开楼层选择

### 3.5 储物箱系统
1. 放置：消耗 50 木材 + 100 金币，K 放置
2. 使用：Space 打开
3. 管理：J 在背包与箱子间转移

### 3.6 海滩与钓鱼
1. 进入海滩：从农场右侧离开或传送点
2. 钓鱼流程：左键蓄力抛竿 → 等待感叹号 → 及时提竿 → 进入小游戏
3. 小游戏：控制滑块覆盖鱼图标直至进度条满
4. 技能影响：钓鱼等级越高，难度越低收益越高

### 3.7 技能系统
按 E 打开技能树，共 4 类：
- 农业：提升额外收获概率
- 采矿：减少体力消耗
- 钓鱼：提高价格与容错
- 烹饪：待实装

## 4. 游戏机制说明

### 4.1 时间与生存
- 每天 6:00 开始，0:00 强制睡觉
- 0:00 未睡或体力耗尽会晕倒并扣钱
- 矿洞中 HP 归零会死亡并丢物品
- 能量为红色时无法工作

### 4.2 战斗细节
- 受伤后短暂无敌
- 攻击可击退怪物，利用地形卡位

### 4.3 作弊与调试
- Tab：跳过一天
- F1 / F2 / F3：快速获取特定物品（如有启用）
- 地图点击可查看坐标（Debug）

### 4.4 位置判定
- 农耕/放置操作基于脚下瓦片坐标
- 操作无效时可微调站位

---

# 第二部分：功能实现与技术细节

## 1. 架构与设计

### 1.1 分层架构
- 表现层：各类 Scene（Game/Menu/House/Mine/Beach）
- 业务逻辑层：Farm/Inventory/Skill/Save/Mining/Time 等管理器
- 数据层：SaveData/ItemSlot/FarmTile/MonsterData 等

### 1.2 设计模式
- 单例：SaveManager、InventoryManager、SkillManager、TimeManager
- 观察者：血量、物品变化、技能升级的 UI 通知
- 工厂：怪物对象创建与生命周期管理

### 1.3 类继承关系（核心）
- Scene：GameScene/MenuScene/HouseScene/MineScene/BeachScene
- Sprite：Player/Monster/Slime/Zombie/Npc
- Node：各管理器与 UI 组件
- Layer：MapLayer/MineLayer/FishingLayer

## 2. 核心系统实现

### 2.1 应用入口与生命周期
- AppDelegate 初始化 OpenGL 视图、分辨率与帧率（1280x720@60FPS）
- 后台/前台切换暂停与恢复动画/音频

### 2.2 场景管理
- 场景切换：replaceScene/pushScene/popScene
- 过渡动画：Fade/Slide/CrossFade
- 场景标准初始化流程：变量 → 地图 → 玩家 → 摄像机 → UI → 输入 → 更新循环

### 2.3 输入系统
- 键盘：移动、通用/特殊交互、背包、技能树、电梯、菜单等
- 鼠标：NPC 点击交互、钓鱼逻辑、坐标获取
- 坐标体系：屏幕 → 视图 → 世界 → 节点

### 2.4 主循环
每帧更新：摄像机 → 玩家 → 怪物 → 农场 → 时间 → 碰撞 → 清理

## 3. 场景与地图

### 3.1 GameScene
- 组件：玩家、地图层、农场管理、背包管理、UI 与 NPC
- 地图加载：TMX 文件（如 farm.tmx）
- 层级管理：UI > 玩家/NPC > 装饰 > 实体 > 地图底层

### 3.2 MineScene
- 楼层机制：按楼层生成地图、怪物、矿石、宝箱与许愿池
- 怪物生成：史莱姆/僵尸随机选择与位置校验

## 4. 农耕系统
- 地块数据结构：记录耕地状态、作物类型、成长阶段
- 生长逻辑：浇水与时间驱动更新
- 收获逻辑：成熟后可收获并产出物品

## 5. 矿洞系统
- 楼层重建流程：清理 → 加载地图 → 刷怪 → 刷矿 → 生成宝箱/许愿池
- 资源分布：矿石随机生成、宝箱概率性刷新

## 6. 战斗系统
- 碰撞检测与伤害结算
- 无敌帧与击退逻辑
- 不同怪物的血量、速度、攻击参数差异

## 7. 背包与物品系统
- 物品槽位与堆叠规则
- 工具栏切换与 UI 同步
- 商店与背包之间的买卖/转移逻辑

## 8. 存档系统
- JSON 序列化保存玩家位置、时间、物品等
- 自动存档：场景退出与新的一天触发
- 加载存档恢复玩家状态

## 9. 技能系统
- 技能类型与经验值管理
- 升级触发加成效果（收获、体力、钓鱼难度等）
- 技能树 UI：等级、经验条、经验文本同步

## 10. NPC 与对话系统
- NPC 数据：姓名、对话列表、类型（村民/商人）
- 对话框 UI：文本显示、选择项逻辑
- 商人交易：Buy/Sell 入口与商品表

## 11. 钓鱼系统
- 状态机：IDLE → CASTING → WAITING → HOOKING → MINIGAME → CAUGHT
- 反应时间与失败判定
- 小游戏：鱼移动、滑块控制、进度增减
- 技能影响：难度系数与收益

## 12. 天气系统
- 天气类型：晴/雨/雪
- 天气生成：根据季节概率生成 7 天预报
- 效果：雨天自动浇水、雪天物价提升、粒子特效与亮度调整

## 13. 时间系统
- 时间流速：真实 1 秒 = 游戏 10 分钟
- 日循环：0:00 强制睡觉与新的一天事件
- 日更逻辑：农场更新、天气更新、体力恢复、商店刷新、自动存档

---

## 版本信息
- 文档版本：v1.0
- 最后更新：2025-12-27
