# 矿洞系统 - 最终版本说明

## ✅ 完成的功能

### 1. 图层显示顺序（最终版本）

**渲染顺序（从下到上）：**
```
1. Front 层      (Z: -200) - 最底层
2. Back 层       (Z: -100) - 背景
3. Buildings 层  (Z: -50)  - 墙壁/碰撞
4. mine1 层      (Z: -25)  - 矿石 ✅ 玩家在矿石上方
5. 玩家          (Z: 10)   - 玩家角色
```

**关键改进：**
- **mine1 层现在保留在 TMX 中**，设置 Z-order 为 -25
- **玩家（Z=10）可以遮住矿石**，实现正确的遮挡效果
- 所有图层都强制设置为可见 `setVisible(true)`

**代码位置：** [MineScene.cpp:144-161](Classes/MineScene.cpp#L144-L161)

---

### 2. Q/E 键切换矿洞场景

**功能说明：**
- **Q 键** - 切换到上一个矿洞场景（1 → 5 循环）
- **E 键** - 切换到下一个矿洞场景（5 → 1 循环）

**支持的场景：**
- `1.tmx` - 第 1 层矿洞
- `2.tmx` - 第 2 层矿洞
- `3.tmx` - 第 3 层矿洞
- `4.tmx` - 第 4 层矿洞
- `5.tmx` - 第 5 层矿洞

**循环逻辑：**
```cpp
// Q 键 - 上一层
当前第 1 层 → 按 Q → 第 5 层
当前第 2 层 → 按 Q → 第 1 层
...

// E 键 - 下一层
当前第 5 层 → 按 E → 第 1 层
当前第 4 层 → 按 E → 第 5 层
...
```

**代码位置：**
- 键盘处理：[MineScene.cpp:816-824](Classes/MineScene.cpp#L816-L824)
- 切换逻辑：[MineScene.cpp:854-882](Classes/MineScene.cpp#L854-L882)

---

## 🎮 完整控制说明

### 主世界（GameScene）
- **L 键** - 直接进入矿洞第 1 层
- **M 键** - 需要靠近电梯才能进入矿洞
- **WASD** - 移动
- **B 键** - 打开/关闭背包
- **ESC** - 返回主菜单

### 矿洞场景（MineScene）
- **WASD** - 移动
- **Q 键** - 切换到上一层矿洞（循环）✨ 新功能
- **E 键** - 切换到下一层矿洞（循环）✨ 新功能
- **J 键** - 攻击/挖矿
- **空格** - 打开宝箱
- **M 键** - 返回农场
- **ESC** - 返回农场
- **I/TAB** - 打开背包
- **1-0 数字键** - 选择工具栏物品

---

## 📁 文件结构要求

确保您的 `Resources/map/Mines/` 文件夹包含以下文件：

```
Resources/map/Mines/
├── 1.tmx          ✅ 第 1 层矿洞
├── 2.tmx          ✅ 第 2 层矿洞
├── 3.tmx          ✅ 第 3 层矿洞
├── 4.tmx          ✅ 第 4 层矿洞
├── 5.tmx          ✅ 第 5 层矿洞
├── mine.png       ✅ 图块集
├── mine2.tsx      （如果有）
├── minekuai.tsx   （如果有）
└── ...
```

**每个 TMX 文件必须包含 4 个图层：**
1. `Front` - 装饰层
2. `Back` - 背景层
3. `Buildings` - 墙壁/碰撞层
4. `mine1` - 矿石层

---

## 🎯 预期效果

### 1. 图层显示
- ✅ Front 层（最底层装饰）
- ✅ Back 层（地面背景）
- ✅ Buildings 层（墙壁）
- ✅ mine1 层（矿石，**被玩家遮挡**）
- ✅ 玩家（在矿石上方）

### 2. 场景切换
- ✅ 按 L 键从主世界进入矿洞第 1 层
- ✅ 按 Q 键切换到上一层（1→5→4→3→2→1 循环）
- ✅ 按 E 键切换到下一层（1→2→3→4→5→1 循环）
- ✅ 切换时有 0.5 秒淡入淡出过渡效果

### 3. 玩家生成
- ✅ 每次切换场景后，玩家生成在地图中心
- ✅ 自动寻找最近的可行走位置
- ✅ 不会生成在墙外或障碍物上

---

## 📊 控制台日志

### 进入矿洞时的日志：
```
========================================
Initializing Mine Scene (Floor 1)
========================================
Initializing mine map...
Mine layer added to scene (Floor 1)
TMX Map position: (0.00, 0.00), Z-order: 0
✓ Front layer found!
  - Position: (0.00, 0.00)
  - Visible: YES
  - Layer Size: (35, 35)
✓ Front layer set to Z-order -200 (below Back)
✓ Back layer found - keeping in tmxMap
  - Back layer visible: YES
✓ Buildings layer found!
  - Visible: YES
  - Layer Size: (35, 35)
✓ Buildings layer set to Z-order -50, forced visible
✓ mine1 layer found!
  - Position: (0.00, 0.00)
  - Visible: YES
  - Layer Size: (35, 35)
✓ mine1 layer set to Z-order -25 (above Buildings, below Player)
...
Map size: (560.00, 560.00) pixels
Map center: (280.00, 280.00)
✓ Center position is walkable
✓ Player positioned at (280.00, 280.00)
Mine Scene initialized successfully!
```

### 切换楼层时的日志：
```
Switching to next floor: 1 -> 2
```
或
```
Switching to previous floor: 1 -> 5
```

---

## 🔧 技术实现

### 1. mine1 层的 Z-order 管理

**之前的方案（已弃用）：**
```cpp
// 提升到场景层级，Z-order = 15
mine1Layer->retain();
tmxMap->removeChild(mine1Layer, false);
this->addChild(mine1Layer, 15);  // ❌ 矿石遮挡玩家
```

**现在的方案（正确）：**
```cpp
// 保留在 TMX 中，设置 Z-order = -25
mine1Layer->setLocalZOrder(-25);  // ✅ 玩家遮挡矿石
mine1Layer->setVisible(true);
```

**为什么这样修改？**
- 玩家的 Z-order 是 10（场景层级）
- mine1 在 TMX 中设置 -25，相对于 tmxMap（Z=0）
- 有效 Z-order：0 + (-25) = -25，远小于玩家的 10
- 结果：玩家渲染在 mine1 上方 ✅

---

### 2. 楼层切换循环逻辑

```cpp
void MineScene::goToNextFloor()
{
    int nextFloor = currentFloor_ + 1;

    // 限制在 1-5 层之间循环
    if (nextFloor > 5)
    {
        nextFloor = 1;  // 循环回第 1 层
    }

    auto nextScene = MineScene::createScene(inventory_, nextFloor);
    Director::getInstance()->replaceScene(TransitionFade::create(0.5f, nextScene));
}
```

**关键点：**
1. 计算下一层编号
2. 超过 5 层时循环回 1 层
3. 创建新场景并切换
4. 使用 0.5 秒淡入淡出过渡

---

## 🧪 测试清单

运行游戏并测试：

### 主世界测试
- [ ] 按 L 键能进入矿洞第 1 层

### 矿洞第 1 层测试
- [ ] 能看到 Front 层（最底层）
- [ ] 能看到 Back 层（地面）
- [ ] 能看到 Buildings 层（墙壁）
- [ ] 能看到 mine1 层（矿石）
- [ ] **玩家能遮住矿石**（走到矿石上方时）
- [ ] 玩家生成在地图中心
- [ ] 玩家被墙壁正确阻挡
- [ ] WASD 可以移动

### Q/E 键切换测试
- [ ] 在第 1 层按 E → 切换到第 2 层
- [ ] 在第 2 层按 E → 切换到第 3 层
- [ ] 在第 3 层按 E → 切换到第 4 层
- [ ] 在第 4 层按 E → 切换到第 5 层
- [ ] 在第 5 层按 E → 循环回第 1 层 ✨
- [ ] 在第 5 层按 Q → 切换到第 4 层
- [ ] 在第 2 层按 Q → 切换到第 1 层
- [ ] 在第 1 层按 Q → 循环到第 5 层 ✨

### 其他功能测试
- [ ] 按 M 或 ESC 返回主世界
- [ ] 切换楼层时有淡入淡出效果
- [ ] 每次切换后玩家重新定位到中心

---

## 📝 图层渲染顺序总结

| 图层 | Z-order | 位置 | 可见性 | 用途 |
|------|---------|------|--------|------|
| Front | -200 | TMX | ✅ | 最底层装饰 |
| Back | -100 | TMX | ✅ | 地面背景 |
| Buildings | -50 | TMX | ✅ | 墙壁/碰撞 |
| **mine1** | **-25** | **TMX** | ✅ | **矿石（被玩家遮挡）** |
| 玩家 | 10 | Scene | ✅ | 玩家角色 |

**有效渲染顺序：**
```
Front(-200) < Back(-100) < Buildings(-50) < mine1(-25) < 玩家(10)
```

**遮挡关系：**
- 玩家站在矿石上 → 玩家遮挡矿石 ✅
- 玩家站在墙壁上 → 玩家遮挡墙壁 ✅
- 玩家走过 Back 层 → 玩家在地面上方 ✅

---

## ✨ 新增功能总结

1. ✅ **mine1 层调整** - 玩家现在可以遮挡矿石
2. ✅ **Q/E 键切换** - 在 1-5 层之间循环切换
3. ✅ **循环逻辑** - 从第 5 层可以循环回第 1 层，从第 1 层可以循环到第 5 层
4. ✅ **过渡效果** - 0.5 秒淡入淡出

---

## 🎉 完成！

所有功能已实现：
- ✅ 四个图层全部正确显示
- ✅ Buildings 层可见
- ✅ Front 层在 Back 层下面
- ✅ **玩家遮挡矿石**（mine1 层）
- ✅ **Q/E 键切换矿洞场景**（1-5 层循环）
- ✅ 玩家生成在地图中心

请运行游戏测试！按 **L** 键进入矿洞，然后用 **Q/E** 键切换不同的矿洞场景。
